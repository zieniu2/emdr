<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EMDR Self-Help Plus - Wsparcie Terapeutyczne</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #121212;
            color: white;
            padding: 20px;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start; /* Zmienione dla lepszego układu przy pełnoekranowym wskaźniku */
            box-sizing: border-box;
            overflow-x: hidden; /* Zapobieganie poziomemu przewijaniu */
        }
        
        .container {
            max-width: 100%;
            width: 600px; /* Ograniczenie szerokości dla lepszej czytelności na desktopie */
            padding: 0 15px;
            box-sizing: border-box;
        }
        
        button {
            background-color: #9c27b0; /* Główny kolor akcji */
            color: white;
            border: none;
            padding: 12px 25px;
            margin: 10px 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #7b1fa2; /* Ciemniejszy odcień przy najechaniu */
        }

        button.secondary {
            background-color: #555;
        }
        button.secondary:hover {
            background-color: #444;
        }
        
        .screen {
            display: none;
            width: 100%;
            background-color: #1e1e1e; /* Tło dla sekcji */
            padding: 20px;
            border-radius: 10px;
            margin-top: 10px; /* Zmniejszony margines */
            box-sizing: border-box;
        }
        #startScreen { margin-top: 0;} /* Brak marginesu dla pierwszego ekranu */
        
        .active {
            display: block;
        }
        
        /* Zmiany dla wskaźnika i jego kontenera */
        #sessionScreen {
            padding: 5px; /* Mniejszy padding dla ekranu sesji */
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Rozmieszczenie elementów */
            height: calc(100vh - 120px); /* Dopasowanie wysokości ekranu sesji */
            min-height: 400px;
        }

        .indicator-container {
            width: 100%;
            flex-grow: 1; /* Kontener wskaźnika zajmuje dostępną przestrzeń */
            min-height: 200px; /* Minimalna wysokość, aby było widać */
            background-color: #2c2c2c; 
            border-radius: 5px;
            margin: 10px 0; /* Zmieniony margines */
            position: relative;
            overflow: hidden;
        }
        
        .indicator {
            width: 80px;  /* Znacznie większy wskaźnik */
            height: 80px; /* Znacznie większy wskaźnik */
            background-color: #ff5722; 
            border-radius: 50%;
            position: absolute;
            left: 0;
            top: 50%; /* Wyśrodkowanie w pionie */
            transform: translateY(-50%); /* Wyśrodkowanie w pionie */
            box-shadow: 0 0 15px #ff5722;
        }
                
        .timer {
            font-size: 20px; 
            margin: 5px 0;
        }
        .session-controls { /* Kontener na timer i przycisk stop */
            padding: 10px 0;
        }
        
        .rating-button-group {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-bottom:15px;
        }
        .rating-button {
            display: inline-block;
            width: 35px; 
            height: 35px;
            line-height: 35px;
            text-align: center;
            background-color: #333;
            color: white;
            border-radius: 50%;
            margin: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .rating-button.selected {
            background-color: #ff5722; 
            font-weight: bold;
        }

        label {
            display: block;
            margin-top: 15px;
            margin-bottom: 5px;
            text-align: left;
            font-weight: bold;
            color: #ccc;
        }
         .label-explanation {
            font-size: 0.8em;
            font-weight: normal;
            color: #aaa;
            display: block;
            text-align: left;
            margin-top: -5px;
            margin-bottom: 5px;
        }
        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: calc(100% - 22px); /* Dostosowanie szerokości */
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            border: 1px solid #444;
            background-color: #333;
            color: white;
            font-size: 16px;
            box-sizing: border-box;
        }
        textarea {
            min-height: 60px;
            resize: vertical;
        }
        
        .checkbox-item, .radio-item {
            margin: 8px 0;
            display: flex;
            align-items: center;
            text-align: left;
        }
        .checkbox-item input[type="checkbox"],
        .radio-item input[type="radio"] {
            margin-right: 10px;
            transform: scale(1.3);
            cursor: pointer;
        }
        .checkbox-item label,
        .radio-item label {
            font-weight: normal;
            color: white;
            cursor: pointer;
            margin-top: 0;
        }

        .support-message {
            position: fixed;
            bottom: 10px; /* Mniejszy odstęp od dołu */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0,0,0,0.8); /* Ciemniejsze dla lepszej czytelności */
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 13px; /* Mniejsza czcionka */
            z-index: 1000; /* Wyżej na wszelki wypadek */
            opacity: 0;
            transition: opacity 0.5s;
            pointer-events: none; /* Aby nie blokować kliknięć pod spodem */
        }
        .support-message.visible {
            opacity: 1;
        }
        .breathing-reminder-pulse {
            animation: pulse 2s infinite ease-in-out;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 5px #9c27b0, inset 0 0 3px rgba(156, 39, 176, 0.5); }
            50% { box-shadow: 0 0 20px #c039de, inset 0 0 10px rgba(192, 57, 222, 0.7); }
            100% { box-shadow: 0 0 5px #9c27b0, inset 0 0 3px rgba(156, 39, 176, 0.5); }
        }
        .header-logo { 
             font-size: 28px;
             font-weight: bold;
             color: #e0e0e0; 
             margin-bottom: 5px;
        }
        .header-subtitle { 
            font-size: 16px;
            color: #aaa; 
            margin-bottom: 20px; /* Zmniejszony margines */
        }
        .info-box {
            background-color: #2a2a2a; 
            padding: 15px;
            border-radius: 8px;
            text-align: left;
            margin-bottom: 20px;
            line-height: 1.6;
            font-size: 14px;
            border-left: 3px solid #9c27b0; 
        }
        .info-box h3 {
            margin-top: 0;
            color: #e0e0e0;
        }
        .info-box ul {
            list-style-type: none;
            padding-left: 5px;
        }
         .info-box ul li::before {
            content: "•";
            color: #9c27b0; 
            font-weight: bold;
            display: inline-block; 
            width: 1em;
            margin-left: -1em;
        }
        /* Styl dla tekstu z instrukcjami na ekranie sesji */
        .session-instructions {
            font-size: 14px; 
            color: #aaa; 
            margin: 5px 0;
        }

    </style>
</head>
<body>
    <div class="container">
        <h1 class="header-logo">EMDR Self-Help Plus</h1>
        <p class="header-subtitle">Twoje narzędzie wsparcia terapeutycznego</p>

        <div id="startScreen" class="screen active">
            <div class="info-box">
                <h3>Witaj Tomaszu,</h3>
                <p>Ta aplikacja została dostosowana, aby wspierać Cię w Twoim procesie terapeutycznym, szczególnie w momentach, gdy:</p>
                <ul>
                    <li>Pojawia się impuls ucieczki przed trudnymi zadaniami (np. retusz, publikacje).</li>
                    <li>Odczuwasz lęk przed oceną lub presję perfekcjonizmu.</li>
                    <li>Chcesz lepiej zrozumieć i zintegrować swoje wewnętrzne części.</li>
                </ul>
                <p>Pamiętaj, że to narzędzie ma Cię wspierać, a praca z obrazami i odczuciami w ciele jest kluczowa.</p>
            </div>
            
            <div>
                <label style="display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 5px;">
                    <input type="checkbox" id="soundToggle" checked style="margin-right: 10px; transform: scale(1.5);">
                    <span>Włącz stymulację dźwiękową</span>
                </label>
                <p style="font-size: 12px; color: #aaa; margin-top: 0px; margin-bottom:15px;">(dla lepszego efektu używaj słuchawek)</p>

                <label style="display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 5px;">
                    <input type="checkbox" id="supportMessagesToggle" style="margin-right: 10px; transform: scale(1.5);">
                    <span>Włącz komunikaty wsparcia podczas sesji</span>
                </label>
                 <p style="font-size: 12px; color: #aaa; margin-top: 0px; margin-bottom:15px;">(np. "Jestem tu z Tobą")</p>

                <label style="display: flex; align-items: center; justify-content: center; cursor: pointer; margin-bottom: 15px;">
                    <input type="checkbox" id="breathingReminderToggle" style="margin-right: 10px; transform: scale(1.5);">
                    <span>Włącz przypomnienie o oddechu</span>
                </label>
            </div>
            
            <button id="newSessionSetupButton">Rozpocznij Nową Sesję</button>
            <button id="quickStartButton" class="secondary">Szybki Start (ostatni problem)</button>
        </div>

        <div id="configScreen" class="screen">
            <h2>Ustawienia Sesji</h2>
            <label for="sessionDuration">Długość sesji:</label>
            <select id="sessionDuration">
                <option value="30">30 sekund</option>
                <option value="60" selected>1 minuta</option>
                <option value="120">2 minuty</option>
                <option value="300">5 minut</option>
                <option value="600">10 minut</option>
            </select>

            <label for="indicatorSpeed">Prędkość wskaźnika:</label>
            <select id="indicatorSpeed">
                <option value="15">Wolno</option> 
                <option value="8" selected>Średnio</option>
                <option value="3">Szybko</option> 
            </select>
            <p class="label-explanation">(Niższa wartość = szybszy ruch. "Szybko" jest bardzo intensywne.)</p>


            <button id="goToPreparationButton">Przejdź do Przygotowania</button>
        </div>
        
        <div id="preparationScreen" class="screen">
            <h2>Przygotowanie do Sesji</h2>
            
            <div class="info-box">
                <p>1. <strong>Zajmij wygodną pozycję.</strong></p>
                <p>2. <strong>Określ, co teraz dominuje</strong> lub z czym chcesz pracować.</p>
                <p>3. <strong>Skup się na odczuciach w ciele</strong> i obrazach, które się pojawiają.</p>
            </div>

            <label for="activePart">Co teraz w Tobie dominuje / z czym chcesz pracować?</label>
            <select id="activePart">
                <option value="">Wybierz...</option>
                <option value="impuls_ucieczki">Impuls ucieczki / unikania zadania (np. retuszu, publikacji)</option>
                <option value="lek_presja">Lęk / presja związana z zadaniem</option>
                <option value="obawa_oceny">Obawa przed oceną / krytyką</option>
                <option value="cien_pogardy">Głos wewnętrznego krytyka / "Cień pogardy"</option>
                <option value="lekliwy_chlopiec">Poczucie bycia małym / "Lękliwy chłopiec"</option>
                <option value="agresywny_chlopiec">Złość / frustracja / "Agresywny chłopiec w cieniu"</option>
                <option value="inne">Inne (opisz poniżej)</option>
            </select>
            <textarea id="activePartOther" placeholder="Opisz, jeśli wybrałeś 'Inne'" style="display:none;"></textarea>

            <div id="therapeuticPrompts" class="info-box" style="display:none; margin-top:15px;">
                </div>

            <label for="bodyLocation">Gdzie w ciele to teraz czujesz najmocniej?</label>
            <input type="text" id="bodyLocation" placeholder="Np. gardło, kark, brzuch, klatka piersiowa...">
            
            <label for="bodySensation">Jakie to uczucie?</label>
            <input type="text" id="bodySensation" placeholder="Np. kamień, drut, wir, ciężar, ucisk, mrowienie, pieczenie/palenie, pustka, zimno, gorąco...">

            <label for="problemImage">Jaki obraz najlepiej reprezentuje to, co teraz czujesz / tę część Ciebie?</label>
            <select id="problemImage">
                <option value="">Wybierz obraz...</option>
                <option value="lekliwy_chlopiec_obraz">Lękliwy chłopiec (skulony, niepewny)</option>
                <option value="agresywny_chlopiec_obraz">Agresywny chłopiec (z mrocznym cieniem samuraja)</option>
                <option value="cien_pogardy_obraz">Cień pogardy (zimne, oceniające spojrzenie)</option>
                <option value="ja_przy_komputerze_presja">Ja przy komputerze, czujący presję</option>
                <option value="inne_obraz">Inny (opisz poniżej)</option>
            </select>
            <textarea id="problemImageOther" placeholder="Opisz obraz, jeśli wybrałeś 'Inny'" style="display:none;"></textarea>

            <label for="negativeCognition">Jaka negatywna myśl lub przekonanie o sobie (NC) towarzyszy temu obrazowi/uczuciu?</label>
            <span class="label-explanation">(NC - Negatywne Przekonanie, czyli negatywna myśl na swój temat, która wydaje się prawdziwa w trudnym momencie)</span>
            <input type="text" id="negativeCognition" list="nc_suggestions" placeholder="Wpisz lub wybierz z sugestii...">
            <datalist id="nc_suggestions">
                <option value="Nie dasz rady, po co próbować">
                <option value="Muszę zasłużyć, żeby być zauważonym">
                <option value="Zniknij. Tylko tak będziesz bezpieczny.">
                <option value="Jestem niewystarczający/a">
                <option value="Coś jest ze mną nie tak">
                <option value="Jestem do niczego">
                <option value="Nie jestem dość dobry/a">
                <option value="To zbyt trudne, nie dam rady :(">
                <option value="I tak Cię wyśmieją/odrzucą/zawiodą się">
            </datalist>
            
            <label for="sudPre">Na skali od 0 (brak) do 10 (maksimum), jak silny jest Twój dyskomfort/napięcie (SUD)?</label>
            <span class="label-explanation">(SUD - Subiektywna Jednostka Dystresu/Zaburzenia, czyli Twoja ocena poziomu dyskomfortu lub napięcia)</span>
            <div id="sudPreButtons" class="rating-button-group">
                </div>
            <button id="beginSessionButton">Rozpocznij Ruch Wskaźnika</button>
        </div>
        
        <div id="sessionScreen" class="screen">
            <div class="session-instructions">
                <p>Utrzymuj głowę nieruchomo. Śledź wzrokiem wskaźnik.</p>
                <p>Skup się na odczuciach w ciele i pozwól myślom swobodnie płynąć.</p>
            </div>
            <div class="indicator-container" id="indicatorContainer">
                <div id="indicator" class="indicator"></div>
            </div>
            <div class="session-controls">
                <div class="timer" id="timerDisplay">01:00</div>
                <p class="session-instructions" style="font-size: 12px; color: #aaa;">Dotknij tła planszy aby zatrzymać/wznowić</p>
                <button id="stopSessionButton" class="secondary">Zakończ Sesję Przed Czasem</button>
            </div>
        </div>
        <div id="supportMessageDisplay" class="support-message"></div>
        
        <div id="endScreen" class="screen">
            <h2>Sesja Zakończona</h2>
             <div class="info-box">
                <p>1. <strong>Weź głęboki oddech</strong> - wykonaj 3 głębokie wdechy i wydechy.</p>
                <p>2. <strong>Sprawdź swoje ciało</strong> - zauważ, jak teraz czuje się twoje ciało.</p>
                <p>3. <strong>Przypomnij sobie problematyczną sytuację/część</strong> - czy coś się zmieniło?</p>
            </div>

            <label for="sudPost">Jak oceniasz swój dyskomfort/napięcie (SUD) teraz (0-10)?</label>
            <span class="label-explanation">(SUD - Subiektywna Jednostka Dystresu/Zaburzenia)</span>
            <div id="sudPostButtons" class="rating-button-group">
                </div>

            <label for="positiveCognition">Jakie pozytywne przekonanie o sobie (PC) chciałbyś teraz przyjąć?</label>
            <span class="label-explanation">(PC - Pozytywne Przekonanie, czyli nowa, wspierająca myśl o sobie, którą chcesz wzmocnić)</span>
            <input type="text" id="positiveCognition" list="pc_suggestions" placeholder="Np. Mogę sobie poradzić, Jestem wystarczający...">
             <datalist id="pc_suggestions">
                <option value="Mogę sobie z tym poradzić">
                <option value="Jestem wystarczający/a taki, jaki jestem">
                <option value="Mam prawo tu być i czuć">
                <option value="Potrafię zaopiekować się sobą">
                <option value="Jestem obecny dla siebie">
                <option value="Uczę się i rozwijam">
                <option value="Mogę ufać sobie">
                <option value="Jestem bezpieczny/a">
            </datalist>

            <label for="vocRating">Na ile prawdziwe wydaje Ci się to PC? (1=wcale, 7=całkowicie)</label>
            <span class="label-explanation">(VoC - Validity of Cognition, czyli Stopień Prawdziwości Pozytywnego Przekonania)</span>
            <div id="vocRatingButtons" class="rating-button-group">
                </div>
            
            <div id="resultsDisplay" style="margin-top: 20px; margin-bottom:20px; font-size: 14px;"></div>

            <label for="sessionNotes">Twoje notatki / Co jeszcze zauważyłeś?</label>
            <textarea id="sessionNotes" placeholder="Twoje myśli, odczucia, obrazy..."></textarea>
            
            <div class="info-box">
                <h3>Co Zaobserwowałeś?</h3>
                <div id="observationsContainer" style="display: flex; flex-direction: column; align-items: flex-start;">
                    </div>
            </div>
             <div class="info-box">
                <h3>Co Teraz?</h3>
                <p id="nextStepsText">Przeanalizuj wyniki i zdecyduj o następnym kroku.</p>
                <ul>
                    <li>Jeśli napięcie znacznie się zmniejszyło (np. SUD spadł o 3+ pkt, PC wydaje się prawdziwe), możesz zakończyć lub przejść do zadania.</li>
                    <li>Rozważ powrót do obrazu "Dorosłego Tomasza" trzymającego wewnętrzne dzieci.</li>
                    <li>Jeśli napięcie jest nadal wysokie, rozważ kolejną krótką sesję na ten sam temat lub inny jego aspekt.</li>
                </ul>
            </div>
            
            <button id="continueSameTopic1minButton">Kontynuuj (ten sam temat, 1 min)</button>
            <button id="continueSameTopic2minButton">Kontynuuj (ten sam temat, 2 min)</button>
            <button id="startCompletelyNewSessionButton" class="secondary">Zupełnie Nowa Sesja</button>
        </div>
    </div>

    <script>
        window.onload = function() {
            var app = {
                screens: {
                    start: document.getElementById('startScreen'),
                    config: document.getElementById('configScreen'),
                    preparation: document.getElementById('preparationScreen'),
                    session: document.getElementById('sessionScreen'),
                    end: document.getElementById('endScreen')
                },
                buttons: {
                    newSessionSetup: document.getElementById('newSessionSetupButton'),
                    quickStart: document.getElementById('quickStartButton'),
                    goToPreparation: document.getElementById('goToPreparationButton'),
                    beginSession: document.getElementById('beginSessionButton'),
                    stopSession: document.getElementById('stopSessionButton'),
                    continueSameTopic1min: document.getElementById('continueSameTopic1minButton'),
                    continueSameTopic2min: document.getElementById('continueSameTopic2minButton'),
                    startCompletelyNewSession: document.getElementById('startCompletelyNewSessionButton')
                },
                elements: {
                    soundToggle: document.getElementById('soundToggle'),
                    supportMessagesToggle: document.getElementById('supportMessagesToggle'),
                    breathingReminderToggle: document.getElementById('breathingReminderToggle'),
                    sessionDuration: document.getElementById('sessionDuration'),
                    indicatorSpeed: document.getElementById('indicatorSpeed'),
                    activePart: document.getElementById('activePart'),
                    activePartOther: document.getElementById('activePartOther'),
                    therapeuticPrompts: document.getElementById('therapeuticPrompts'),
                    bodyLocation: document.getElementById('bodyLocation'),
                    bodySensation: document.getElementById('bodySensation'),
                    problemImage: document.getElementById('problemImage'),
                    problemImageOther: document.getElementById('problemImageOther'),
                    negativeCognition: document.getElementById('negativeCognition'),
                    sudPreButtonsContainer: document.getElementById('sudPreButtons'),
                    indicator: document.getElementById('indicator'),
                    indicatorContainer: document.getElementById('indicatorContainer'),
                    timerDisplay: document.getElementById('timerDisplay'),
                    supportMessageDisplay: document.getElementById('supportMessageDisplay'),
                    sudPostButtonsContainer: document.getElementById('sudPostButtons'),
                    positiveCognition: document.getElementById('positiveCognition'),
                    vocRatingButtonsContainer: document.getElementById('vocRatingButtons'),
                    resultsDisplay: document.getElementById('resultsDisplay'),
                    sessionNotes: document.getElementById('sessionNotes'),
                    observationsContainer: document.getElementById('observationsContainer'),
                    nextStepsText: document.getElementById('nextStepsText')
                },
                state: {
                    settings: {
                        duration: 60, 
                        speed: 8,    // Zmienione wartości prędkości (opóźnienie)
                        soundEnabled: true,
                        supportMessagesEnabled: false,
                        breathingReminderEnabled: false,
                    },
                    currentProblem: {
                        activePart: '', activePartOther: '',
                        bodyLocation: '', bodySensation: '',
                        problemImage: '', problemImageOther: '',
                        negativeCognition: '', sudPre: null,
                        positiveCognition: '', voc: null, sudPost: null,
                        notes: '', observations: []
                    },
                    lastProblem: null, 
                    isPaused: false,
                    timerId: null,
                    animationFrameId: null, // Będzie używane z setTimeout dla kontroli prędkości
                    audioContext: null,
                    supportMessageIntervalId: null,
                    breathingReminderIntervalId: null,
                    indicatorDirection: 1,
                    indicatorPosition: 0,
                },
                therapeuticData: {
                    prompts: {
                        cien_pogardy: "Skup się na tym zimnym, oceniającym spojrzeniu. Gdzie je czujesz w ciele? Jaki impuls w Tobie uruchamia? Pamiętaj, że Dorosły Ty może być obecny przy tej części, nie musisz jej zmieniać.",
                        lekliwy_chlopiec: "Zobacz tego małego, lękliwego chłopca. Czego się boi? Czego potrzebuje? Jak Dorosły Ty możesz mu towarzyszyć z obecnością i współczuciem?",
                        agresywny_chlopiec: "Poczuj energię tego 'agresywnego chłopca w cieniu'. Co kryje się za tą siłą? Jaki lęk lub potrzeba? Dorosły Ty może spotkać tę część z ciekawością.",
                        impuls_ucieczki: "Zauważ ten impuls do ucieczki. Gdzie go czujesz w ciele? Zamiast działać automatycznie, spróbuj być z tym uczuciem przez chwilę. Co się pojawi, gdy nie uciekniesz?",
                        obawa_oceny: "Poczuj tę obawę przed oceną. Jakie myśli jej towarzyszą? Jaki obraz siebie widzisz w tej sytuacji? Dorosły Ty może spojrzeć na to z dystansem i współczuciem."
                    },
                    supportMessages: [
                        "Jestem tu z Tobą.",
                        "Nie musisz tego zmieniać, po prostu bądź.",
                        "Widzę Cię.",
                        "Jesteś bezpieczny/a, by to czuć.",
                        "Pozwól, by to płynęło.",
                        "Oddychaj w to miejsce.",
                        "Nie przyszedłem Cię zmieniać. Przyszedłem, żeby z Tobą być."
                    ],
                    observations: [
                        "Czułem fizyczne rozluźnienie w ciele", "Zauważyłem zmianę miejsca napięcia w ciele",
                        "Nie zauważyłem fizycznych zmian", "Moje myśli stały się spokojniejsze",
                        "Miałem trudności z utrzymaniem koncentracji", "Pojawiły się nowe myśli/perspektywy",
                        "Problem wydaje się teraz mniej ważny", "Odczuwam większą pewność siebie w kwestii problemu",
                        "Łatwiej mi myśleć o rozwiązaniach", "Oddychanie stało się głębsze/spokojniejsze",
                        "Poczułem większy kontakt z 'Dorosłym Ja'", "Nie zauważyłem żadnych zmian",
                        "Potrzebuję więcej pracy z tym tematem"
                    ]
                }
            };

            function showScreen(screenId) {
                for (var key in app.screens) {
                    app.screens[key].classList.remove('active');
                }
                app.screens[screenId].classList.add('active');
                window.scrollTo(0, 0); 
            }

            function createRatingButtons(container, maxRating, stateProperty, isVoc = false) {
                container.innerHTML = '';
                for (let i = (isVoc ? 1 : 0); i <= maxRating; i++) {
                    let btn = document.createElement('div');
                    btn.classList.add('rating-button');
                    btn.textContent = i;
                    btn.dataset.value = i;
                    btn.addEventListener('click', function() {
                        Array.from(container.children).forEach(b => b.classList.remove('selected'));
                        this.classList.add('selected');
                        app.state.currentProblem[stateProperty] = parseInt(this.dataset.value);
                        if (stateProperty === 'sudPost' || stateProperty === 'voc') updateResultsDisplay();
                    });
                    container.appendChild(btn);
                }
            }
            
            function createObservationCheckboxes() {
                app.elements.observationsContainer.innerHTML = '';
                app.therapeuticData.observations.forEach((obsText, index) => {
                    const id = `obs${index}`;
                    const div = document.createElement('div');
                    div.className = 'checkbox-item';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = id;
                    input.value = obsText;
                    input.addEventListener('change', function() {
                        const value = this.value;
                        if (this.checked) {
                            if (!app.state.currentProblem.observations.includes(value)) {
                                app.state.currentProblem.observations.push(value);
                            }
                        } else {
                            app.state.currentProblem.observations = app.state.currentProblem.observations.filter(item => item !== value);
                        }
                    });

                    const label = document.createElement('label');
                    label.htmlFor = id;
                    label.textContent = obsText;

                    div.appendChild(input);
                    div.appendChild(label);
                    app.elements.observationsContainer.appendChild(div);
                });
            }

            function resetCurrentProblem() {
                app.state.currentProblem = {
                    activePart: '', activePartOther: '',
                    bodyLocation: '', bodySensation: '',
                    problemImage: '', problemImageOther: '',
                    negativeCognition: '', sudPre: null,
                    positiveCognition: '', voc: null, sudPost: null,
                    notes: '', observations: []
                };
                app.elements.activePart.value = '';
                app.elements.activePartOther.value = ''; app.elements.activePartOther.style.display = 'none';
                app.elements.therapeuticPrompts.style.display = 'none'; app.elements.therapeuticPrompts.textContent = '';
                app.elements.bodyLocation.value = '';
                app.elements.bodySensation.value = '';
                app.elements.problemImage.value = '';
                app.elements.problemImageOther.value = ''; app.elements.problemImageOther.style.display = 'none';
                app.elements.negativeCognition.value = '';
                app.elements.positiveCognition.value = '';
                app.elements.sessionNotes.value = '';
                
                Array.from(app.elements.sudPreButtonsContainer.children).forEach(b => b.classList.remove('selected'));
                Array.from(app.elements.sudPostButtonsContainer.children).forEach(b => b.classList.remove('selected'));
                Array.from(app.elements.vocRatingButtonsContainer.children).forEach(b => b.classList.remove('selected'));
                Array.from(app.elements.observationsContainer.querySelectorAll('input[type="checkbox"]')).forEach(cb => cb.checked = false);
                app.elements.resultsDisplay.innerHTML = '';
            }
            
            function populatePreparationScreenFromProblem(problem) {
                 if (!problem) return;
                app.elements.activePart.value = problem.activePart || '';
                handleActivePartChange(); 
                app.elements.activePartOther.value = problem.activePartOther || '';
                app.elements.bodyLocation.value = problem.bodyLocation || '';
                app.elements.bodySensation.value = problem.bodySensation || '';
                app.elements.problemImage.value = problem.problemImage || '';
                handleProblemImageChange(); 
                app.elements.problemImageOther.value = problem.problemImageOther || '';
                app.elements.negativeCognition.value = problem.negativeCognition || '';
                if (problem.sudPre !== null) {
                    const btn = app.elements.sudPreButtonsContainer.querySelector(`.rating-button[data-value="${problem.sudPre}"]`);
                    if (btn) btn.click(); 
                }
            }

            function saveSettings() {
                localStorage.setItem('emdrAppSettings', JSON.stringify(app.state.settings));
            }

            function loadSettings() {
                const saved = localStorage.getItem('emdrAppSettings');
                if (saved) {
                    app.state.settings = JSON.parse(saved);
                }
                app.elements.sessionDuration.value = app.state.settings.duration;
                app.elements.indicatorSpeed.value = app.state.settings.speed;
                app.elements.soundToggle.checked = app.state.settings.soundEnabled;
                app.elements.supportMessagesToggle.checked = app.state.settings.supportMessagesEnabled;
                app.elements.breathingReminderToggle.checked = app.state.settings.breathingReminderEnabled;
            }

            function saveLastProblem() {
                localStorage.setItem('emdrAppLastProblem', JSON.stringify(app.state.currentProblem));
            }
            function loadLastProblem() {
                const saved = localStorage.getItem('emdrAppLastProblem');
                if (saved) {
                    app.state.lastProblem = JSON.parse(saved);
                } else {
                    app.state.lastProblem = null;
                }
            }

            function handleActivePartChange() {
                const selectedPart = app.elements.activePart.value;
                app.elements.activePartOther.style.display = (selectedPart === 'inne') ? 'block' : 'none';
                if (selectedPart === 'inne') app.elements.activePartOther.focus();
                
                if (app.therapeuticData.prompts[selectedPart]) {
                    app.elements.therapeuticPrompts.textContent = app.therapeuticData.prompts[selectedPart];
                    app.elements.therapeuticPrompts.style.display = 'block';
                } else {
                    app.elements.therapeuticPrompts.style.display = 'none';
                }
            }
             function handleProblemImageChange() {
                app.elements.problemImageOther.style.display = (app.elements.problemImage.value === 'inne_obraz') ? 'block' : 'none';
                 if (app.elements.problemImage.value === 'inne_obraz') app.elements.problemImageOther.focus();
            }

            function startTimer(duration) {
                app.state.timeRemaining = duration;
                updateTimerDisplay();
                
                app.state.timerId = setInterval(function() {
                    if (!app.state.isPaused) {
                        app.state.timeRemaining--;
                        updateTimerDisplay();
                        
                        if (app.state.timeRemaining <= 0) {
                            completeSession();
                        }
                    }
                }, 1000);
            }
            
            function updateTimerDisplay() {
                var minutes = Math.floor(app.state.timeRemaining / 60);
                var seconds = app.state.timeRemaining % 60;
                app.elements.timerDisplay.textContent = 
                    minutes.toString().padStart(2, '0') + ':' + 
                    seconds.toString().padStart(2, '0');
            }
            
            function startAnimation(delayValue) { 
                var container = app.elements.indicatorContainer;
                var containerWidth = container.offsetWidth;
                var indicatorWidth = app.elements.indicator.offsetWidth;
                var stepSize = 3; // Zwiększona ilość pikseli na krok dla szybszego wrażenia

                function animate() {
                    if (app.state.isPaused) { // Sprawdź pauzę na początku
                        app.state.animationFrameId = setTimeout(() => requestAnimationFrame(animate), delayValue);
                        return;
                    }

                    app.state.indicatorPosition += stepSize * app.state.indicatorDirection;
                        
                    if (app.state.indicatorPosition >= containerWidth - indicatorWidth) {
                        app.state.indicatorPosition = containerWidth - indicatorWidth;
                        app.state.indicatorDirection = -1;
                        playSound(false); 
                    } else if (app.state.indicatorPosition <= 0) {
                        app.state.indicatorPosition = 0;
                        app.state.indicatorDirection = 1;
                        playSound(true); 
                    }
                        
                    app.elements.indicator.style.left = app.state.indicatorPosition + 'px';
                    
                    app.state.animationFrameId = setTimeout(() => requestAnimationFrame(animate), delayValue);
                }
                
                if (app.state.animationFrameId) clearTimeout(app.state.animationFrameId);
                app.state.animationFrameId = setTimeout(() => requestAnimationFrame(animate), delayValue);
            }

            function stopAnimationAndTimers() {
                clearInterval(app.state.timerId);
                app.state.timerId = null;
                if (app.state.animationFrameId) {
                    clearTimeout(app.state.animationFrameId); 
                    app.state.animationFrameId = null;
                }
                if (app.state.supportMessageIntervalId) {
                    clearInterval(app.state.supportMessageIntervalId);
                    app.state.supportMessageIntervalId = null;
                    app.elements.supportMessageDisplay.classList.remove('visible');
                }
                if (app.state.breathingReminderIntervalId) {
                    clearInterval(app.state.breathingReminderIntervalId);
                    app.state.breathingReminderIntervalId = null;
                    app.elements.indicatorContainer.classList.remove('breathing-reminder-pulse');
                }
                app.state.isPaused = false; 
                app.screens.session.style.backgroundColor = '#1e1e1e'; 
            }
            
            function completeSession() {
                stopAnimationAndTimers();
                app.state.currentProblem.activePart = app.elements.activePart.value;
                app.state.currentProblem.activePartOther = app.elements.activePartOther.value;
                app.state.currentProblem.bodyLocation = app.elements.bodyLocation.value;
                app.state.currentProblem.bodySensation = app.elements.bodySensation.value;
                app.state.currentProblem.problemImage = app.elements.problemImage.value;
                app.state.currentProblem.problemImageOther = app.elements.problemImageOther.value;
                app.state.currentProblem.negativeCognition = app.elements.negativeCognition.value;
                
                saveLastProblem(); 
                showScreen('end');
            }

            function setupAudio() {
                if (!app.state.audioContext && app.state.settings.soundEnabled) {
                    try {
                        app.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    } catch(e) {
                        console.warn('Web Audio API nie jest wspierane.');
                        app.state.settings.soundEnabled = false; // Wyłącz dźwięk, jeśli nie ma wsparcia
                        app.elements.soundToggle.checked = false;
                    }
                }
            }
            
            function playSound(isLeft) {
                if (!app.state.settings.soundEnabled || app.state.isPaused || !app.state.audioContext) return;
                
                try {
                    var audioCtx = app.state.audioContext;
                     if (audioCtx.state === 'suspended') { // Potrzebna interakcja użytkownika do wznowienia
                        audioCtx.resume();
                    }
                    var oscillator = audioCtx.createOscillator();
                    var gainNode = audioCtx.createGain();
                    var panner = audioCtx.createStereoPanner ? audioCtx.createStereoPanner() : null;

                    oscillator.type = 'sine';
                    oscillator.frequency.setValueAtTime(isLeft ? 280 : 380, audioCtx.currentTime);
                    gainNode.gain.setValueAtTime(0.08, audioCtx.currentTime); 

                    if (panner) {
                        panner.pan.setValueAtTime(isLeft ? -1.0 : 1.0, audioCtx.currentTime);
                        oscillator.connect(gainNode).connect(panner).connect(audioCtx.destination);
                    } else { 
                        oscillator.connect(gainNode).connect(audioCtx.destination);
                    }
                    
                    oscillator.start(audioCtx.currentTime);
                    oscillator.stop(audioCtx.currentTime + 0.05); 
                } catch(e) {
                    console.error('Błąd odtwarzania dźwięku:', e);
                }
            }
            
            function startSupportMessages() {
                if (!app.state.settings.supportMessagesEnabled || app.state.supportMessageIntervalId) return;
                
                const showMsg = () => {
                    if (app.state.isPaused) return;
                    const randomIndex = Math.floor(Math.random() * app.therapeuticData.supportMessages.length);
                    app.elements.supportMessageDisplay.textContent = app.therapeuticData.supportMessages[randomIndex];
                    app.elements.supportMessageDisplay.classList.add('visible');
                    setTimeout(() => {
                        app.elements.supportMessageDisplay.classList.remove('visible');
                    }, 3500); 
                };
                // showMsg(); Nie pokazuj od razu, poczekaj na interwał
                app.state.supportMessageIntervalId = setInterval(showMsg, 20000); 
            }

            function startBreathingReminder() {
                if (!app.state.settings.breathingReminderEnabled || app.state.breathingReminderIntervalId) return;
                app.state.breathingReminderIntervalId = setInterval(() => {
                    if (app.state.isPaused) return;
                    app.elements.indicatorContainer.classList.add('breathing-reminder-pulse');
                    setTimeout(() => {
                        app.elements.indicatorContainer.classList.remove('breathing-reminder-pulse');
                    }, 4000); 
                }, 30000); 
            }

            function updateResultsDisplay() {
                const { sudPre, sudPost, positiveCognition, voc } = app.state.currentProblem;
                let html = '<div class="info-box" style="border-left-color: #ff5722;"><h3>Wyniki Sesji:</h3>';
                let preText = sudPre !== null ? `${sudPre}/10` : 'N/A';
                let postText = sudPost !== null ? `${sudPost}/10` : 'N/A';
                html += `<p>Napięcie (SUD) przed: <strong>${preText}</strong></p>`;
                html += `<p>Napięcie (SUD) po: <strong>${postText}</strong></p>`;

                if (sudPre !== null && sudPost !== null) {
                    const diff = sudPre - sudPost;
                    let diffText, color;
                    if (diff > 2) { diffText = `Znaczne zmniejszenie o ${diff} pkt.`; color = "#4caf50"; }
                    else if (diff > 0) { diffText = `Zmniejszenie o ${diff} pkt.`; color = "#8bc34a"; }
                    else if (diff === 0) { diffText = "Brak zmiany w SUD."; color = "#ffc107"; }
                    else { diffText = `Zwiększenie o ${Math.abs(diff)} pkt.`; color = "#f44336"; }
                    html += `<p style="color: ${color};"><strong>${diffText}</strong></p>`;
                }

                if (positiveCognition) {
                    html += `<p style="margin-top:10px;">Pozytywne Przekonanie (PC): <strong>"${positiveCognition}"</strong></p>`;
                    if (voc !== null) {
                        html += `<p>Prawdziwość PC (VoC): <strong>${voc}/7</strong></p>`;
                    }
                }
                html += '</div>';
                app.elements.resultsDisplay.innerHTML = html;
            }

            // ---- EVENT LISTENERS ----
            app.elements.soundToggle.addEventListener('change', function() {
                app.state.settings.soundEnabled = this.checked;
                saveSettings();
                if (this.checked && !app.state.audioContext) setupAudio();
            });
            app.elements.supportMessagesToggle.addEventListener('change', function() {
                app.state.settings.supportMessagesEnabled = this.checked;
                saveSettings();
                 if (!this.checked && app.state.supportMessageIntervalId) { // Wyłącz, jeśli odznaczono
                    clearInterval(app.state.supportMessageIntervalId);
                    app.state.supportMessageIntervalId = null;
                    app.elements.supportMessageDisplay.classList.remove('visible');
                }
            });
            app.elements.breathingReminderToggle.addEventListener('change', function() {
                app.state.settings.breathingReminderEnabled = this.checked;
                saveSettings();
                if (!this.checked && app.state.breathingReminderIntervalId) { // Wyłącz, jeśli odznaczono
                    clearInterval(app.state.breathingReminderIntervalId);
                    app.state.breathingReminderIntervalId = null;
                    app.elements.indicatorContainer.classList.remove('breathing-reminder-pulse');
                }
            });
            
            app.buttons.newSessionSetup.addEventListener('click', function() {
                resetCurrentProblem();
                showScreen('config');
            });

            app.buttons.quickStart.addEventListener('click', function() {
                loadLastProblem();
                if (app.state.lastProblem && Object.keys(app.state.lastProblem).length > 0 && app.state.lastProblem.activePart) { // Sprawdź czy są dane
                    app.state.currentProblem = JSON.parse(JSON.stringify(app.state.lastProblem)); 
                    populatePreparationScreenFromProblem(app.state.currentProblem);
                    app.state.settings.duration = parseInt(app.elements.sessionDuration.value); // Użyj aktualnych ustawień z UI
                    app.state.settings.speed = parseInt(app.elements.indicatorSpeed.value); 
                    showScreen('preparation');
                } else {
                    alert("Brak danych z ostatniej sesji lub dane są niekompletne. Rozpocznij nową sesję od konfiguracji.");
                    resetCurrentProblem();
                    showScreen('config');
                }
            });

            app.elements.sessionDuration.addEventListener('change', function() {
                app.state.settings.duration = parseInt(this.value);
                saveSettings();
            });
            app.elements.indicatorSpeed.addEventListener('change', function() {
                app.state.settings.speed = parseInt(this.value); 
                saveSettings();
            });

            app.buttons.goToPreparation.addEventListener('click', function() {
                showScreen('preparation');
            });
            
            app.elements.activePart.addEventListener('change', handleActivePartChange);
            app.elements.problemImage.addEventListener('change', handleProblemImageChange);


            app.buttons.beginSession.addEventListener('click', function() {
                if (app.state.currentProblem.sudPre === null) {
                    alert('Proszę wybrać poziom napięcia (SUD) przed sesją.');
                    return;
                }
                app.state.currentProblem.activePart = app.elements.activePart.value;
                app.state.currentProblem.activePartOther = app.elements.activePartOther.value;
                app.state.currentProblem.bodyLocation = app.elements.bodyLocation.value;
                app.state.currentProblem.bodySensation = app.elements.bodySensation.value;
                app.state.currentProblem.problemImage = app.elements.problemImage.value;
                app.state.currentProblem.problemImageOther = app.elements.problemImageOther.value;
                app.state.currentProblem.negativeCognition = app.elements.negativeCognition.value;

                app.state.indicatorPosition = 0;
                app.state.indicatorDirection = 1;
                app.elements.indicator.style.left = '0px';


                showScreen('session');
                setupAudio(); 
                startTimer(app.state.settings.duration);
                startAnimation(app.state.settings.speed); 
                if(app.state.settings.supportMessagesEnabled) startSupportMessages();
                if(app.state.settings.breathingReminderEnabled) startBreathingReminder();
            });

            app.buttons.stopSession.addEventListener('click', function() {
                completeSession(); 
            });
            
            function startContinuationSession(duration) {
                app.state.settings.duration = duration;
                app.state.currentProblem.sudPre = app.state.currentProblem.sudPost; 
                app.state.currentProblem.sudPost = null; 
                app.state.currentProblem.voc = null; 
                
                // Zachowaj PC i notatki, jeśli użytkownik chce kontynuować ten sam problem
                // app.state.currentProblem.positiveCognition = app.elements.positiveCognition.value;
                // app.state.currentProblem.notes = app.elements.sessionNotes.value;
                // app.state.currentProblem.observations = []; // Można zresetować lub pozwolić na dodawanie


                app.state.indicatorPosition = 0;
                app.state.indicatorDirection = 1;
                app.elements.indicator.style.left = '0px';

                showScreen('session');
                startTimer(app.state.settings.duration);
                startAnimation(app.state.settings.speed);
                if(app.state.settings.supportMessagesEnabled) startSupportMessages();
                if(app.state.settings.breathingReminderEnabled) startBreathingReminder();
            }

            app.buttons.continueSameTopic1min.addEventListener('click', function() {
                startContinuationSession(60);
            });
             app.buttons.continueSameTopic2min.addEventListener('click', function() {
                startContinuationSession(120);
            });

            app.buttons.startCompletelyNewSession.addEventListener('click', function() {
                app.state.currentProblem.positiveCognition = app.elements.positiveCognition.value;
                app.state.currentProblem.notes = app.elements.sessionNotes.value;
                saveLastProblem(); 

                resetCurrentProblem();
                showScreen('config'); 
            });
            
            // Modyfikacja event listenera dla pauzy, aby działał tylko na kontenerze wskaźnika
            app.elements.indicatorContainer.addEventListener('click', function(e) {
                 // Interakcja użytkownika potrzebna do wznowienia AudioContext w niektórych przeglądarkach
                if (app.state.audioContext && app.state.audioContext.state === 'suspended') {
                    app.state.audioContext.resume();
                }

                app.state.isPaused = !app.state.isPaused;
                // Zmieniamy tło całego ekranu sesji dla lepszej widoczności pauzy
                app.screens.session.style.backgroundColor = 
                    app.state.isPaused ? '#2d1d30' : '#1e1e1e'; 
                
                if (app.state.isPaused) {
                    if (app.state.supportMessageIntervalId) clearInterval(app.state.supportMessageIntervalId);
                    // Nie resetujemy ID, aby można było wznowić interwał
                    if (app.state.breathingReminderIntervalId) clearInterval(app.state.breathingReminderIntervalId);
                    app.elements.indicatorContainer.classList.remove('breathing-reminder-pulse');
                } else {
                    // Wznów animację (jest w pętli setTimeout, więc sama się wznowi po odznaczeniu pauzy)
                    // Wznów interwały, jeśli były aktywne
                    if(app.state.settings.supportMessagesEnabled) startSupportMessages();
                    if(app.state.settings.breathingReminderEnabled) startBreathingReminder();
                }
            });


             app.elements.positiveCognition.addEventListener('input', function() {
                app.state.currentProblem.positiveCognition = this.value;
                updateResultsDisplay();
            });
            app.elements.sessionNotes.addEventListener('input', function() {
                app.state.currentProblem.notes = this.value;
            });

            loadSettings();
            loadLastProblem(); 
            createRatingButtons(app.elements.sudPreButtonsContainer, 10, 'sudPre');
            createRatingButtons(app.elements.sudPostButtonsContainer, 10, 'sudPost');
            createRatingButtons(app.elements.vocRatingButtonsContainer, 7, 'voc', true);
            createObservationCheckboxes();
            resetCurrentProblem(); 
            showScreen('start');
        };
    </script>
</body>
</html>
